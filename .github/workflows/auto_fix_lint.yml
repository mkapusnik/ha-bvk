name: Auto-fix lint (Gemini)

on:
  workflow_run:
    workflows: ['Run sanity tests']
    types: [completed]
    branches: [develop]

concurrency:
  group: auto-fix-lint-${{ github.event.workflow_run.id }}
  cancel-in-progress: false

permissions:
  actions: read
  contents: write
  pull-requests: write

jobs:
  detect-lint-failure:
    name: Detect lint failure
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    outputs:
      should_run: ${{ steps.detect.outputs.should_run }}
      reason: ${{ steps.detect.outputs.reason }}
    steps:
      - name: Fetch jobs JSON
        id: fetch
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.event.workflow_run.id }}
        shell: bash
        run: |
          set -euo pipefail
          gh api -H 'Accept: application/vnd.github+json' \
            "/repos/${REPO}/actions/runs/${RUN_ID}/jobs" --paginate > jobs.json
          echo "jobs_json<<EOF" >> "$GITHUB_OUTPUT"
          cat jobs.json >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Detect failed lint step (from JSON)
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          import os

          jobs = json.loads(os.environ['JOBS_JSON'])
          for job in jobs.get('jobs', []):
            name = (job.get('name') or '').strip()
            if name != 'Lint check':
              continue
            if job.get('conclusion') != 'failure':
              continue
            for step in job.get('steps') or []:
              if (step.get('name') or '').strip() == 'Ruff check' and step.get('conclusion') == 'failure':
                print('::notice::Detected Ruff check failure in sanity.yml')
                with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as f:
                  f.write('should_run=true\n')
                  f.write('reason=Lint check / Ruff check failed\n')
                raise SystemExit(0)

          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as f:
            f.write('should_run=false\n')
            f.write('reason=Failure was not Ruff check\n')
          PY
        env:
          JOBS_JSON: ${{ steps.fetch.outputs.jobs_json }}

  fix-lint:
    name: Fix lint and open PR
    runs-on: ubuntu-latest
    needs: detect-lint-failure
    if: ${{ needs.detect-lint-failure.outputs.should_run == 'true' }}
    steps:
      - name: Checkout failing SHA
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install ruff
        shell: bash
        run: python -m pip install --upgrade pip ruff

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install Gemini CLI
        shell: bash
        run: npm install -g @google/gemini-cli

      - name: Create lint branch
        id: branch
        shell: bash
        run: |
          set -euo pipefail
          short_sha="$(git rev-parse --short=8 HEAD)"
          branch="lint-${{ github.event.workflow_run.id }}-${short_sha}"
          git checkout -b "$branch"
          echo "name=$branch" >> "$GITHUB_OUTPUT"

      - name: Run Gemini agent to fix ruff
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          cat > AGENT_INSTRUCTIONS.txt <<'EOF'
          You are an automated lint-fix agent running in GitHub Actions.

          Goal: fix all lint issues reported by `ruff check .`.

          Rules:
          - Make the smallest safe changes.
          - Do not change runtime behavior unless required to fix lint.
          - Keep edits focused; avoid refactors.

          Steps:
          1) Run: ruff check .
          2) Fix issues (use ruff auto-fix if appropriate).
          3) Re-run: ruff check . until it exits 0.
          4) Do not run formatting unless needed.
          EOF

          gemini --non-interactive \
            --prompt "$(cat AGENT_INSTRUCTIONS.txt)" \
            -- "bash" "-lc" "ruff check . || true; ruff check . --fix || true; ruff check ."

      - name: Commit changes (if any)
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No changes to commit. Exiting."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Fix ruff lint errors"

      - name: Push branch
        shell: bash
        run: |
          set -euo pipefail
          git push -u origin "${{ steps.branch.outputs.name }}"

      - name: Create pull request
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          branch="${{ steps.branch.outputs.name }}"
          base="develop"

          run_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}"

          if gh pr list --head "$branch" --base "$base" --state open --json number --jq 'length' | grep -qv '^0$'; then
            echo "PR already exists for $branch -> $base"
            exit 0
          fi

          gh pr create \
            --title "Fix lint: ruff" \
            --body "Automated lint fix for ruff failures detected in the \"Run sanity tests\" workflow.\n\nSource run: ${run_url}\n" \
            --head "$branch" \
            --base "$base"
