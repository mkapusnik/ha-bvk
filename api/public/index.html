<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>BVK Water Meter Readings</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Space+Grotesk:wght@500;700&display=swap"
    />
    <style>
      :root {
        color-scheme: light;
        --bg: #f4f7fb;
        --bg-accent: #e6efff;
        --bg-spot: #f8f2ea;
        --card: #ffffff;
        --card-shadow: 0 30px 60px rgba(19, 46, 98, 0.12);
        --card-border: rgba(33, 54, 95, 0.12);
        --ink: #0e1a2b;
        --muted: #516070;
        --accent: #2a5cff;
        --accent-strong: #0d3fe6;
        --chip: rgba(42, 92, 255, 0.12);
        --chip-text: #1e3fbf;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "DM Sans", "Segoe UI", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(1200px 600px at 10% 0%, var(--bg-accent), transparent 60%),
          radial-gradient(900px 500px at 90% 10%, var(--bg-spot), transparent 55%),
          var(--bg);
      }

      body::before {
        content: "";
        position: fixed;
        inset: 0;
        background-image: linear-gradient(
            115deg,
            rgba(42, 92, 255, 0.08) 0%,
            rgba(42, 92, 255, 0) 45%
          ),
          linear-gradient(
            300deg,
            rgba(13, 63, 230, 0.06) 0%,
            rgba(13, 63, 230, 0) 40%
          );
        pointer-events: none;
        z-index: -1;
      }

      a {
        color: inherit;
      }

      #app {
        max-width: 1080px;
        margin: 0 auto;
        padding: 48px 24px 80px;
      }

      .hero {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 32px;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--chip);
        color: var(--chip-text);
        border-radius: 999px;
        padding: 6px 14px;
        font-size: 13px;
        font-weight: 600;
        letter-spacing: 0.02em;
        text-transform: uppercase;
      }

      .hero h1 {
        font-family: "Space Grotesk", "DM Sans", sans-serif;
        font-size: clamp(32px, 4vw, 46px);
        margin: 0;
      }

      .hero p {
        margin: 0;
        font-size: 17px;
        color: var(--muted);
        max-width: 640px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 24px;
      }

      .card {
        position: relative;
        background: var(--card);
        border-radius: 24px;
        border: 1px solid var(--card-border);
        box-shadow: var(--card-shadow);
        padding: 28px;
        overflow: hidden;
      }

      .section-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 600;
        color: var(--muted);
        margin-bottom: 18px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 12px;
      }

      .reading-value {
        font-family: "Space Grotesk", "DM Sans", sans-serif;
        font-size: clamp(34px, 5vw, 54px);
        font-weight: 700;
        letter-spacing: -0.02em;
      }

      .reading-meta {
        margin-top: 8px;
        color: var(--muted);
        font-size: 15px;
      }

      .history-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-height: 360px;
        overflow: auto;
        padding-right: 4px;
      }

      .history-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        background: rgba(255, 255, 255, 0.65);
        border-radius: 16px;
        padding: 14px 16px;
        border: 1px solid rgba(42, 92, 255, 0.08);
        backdrop-filter: blur(6px);
        animation: fadeUp 0.5s ease both;
      }

      .history-item span {
        display: block;
      }

      .history-reading {
        font-weight: 600;
        font-size: 16px;
      }

      .history-date {
        color: var(--muted);
        font-size: 13px;
      }

      .footer {
        margin-top: 28px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        color: var(--muted);
        font-size: 14px;
      }

      .link-pill {
        background: white;
        border: 1px solid rgba(42, 92, 255, 0.18);
        color: var(--accent-strong);
        border-radius: 999px;
        padding: 6px 12px;
        font-weight: 600;
        text-decoration: none;
      }

      .loading {
        color: var(--muted);
        font-size: 15px;
      }

      .error {
        color: #b42318;
        background: #fee4e2;
        padding: 10px 12px;
        border-radius: 12px;
        font-size: 14px;
      }

      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .reveal {
        animation: fadeUp 0.7s ease both;
      }

      @media (max-width: 640px) {
        #app {
          padding: 36px 18px 64px;
        }

        .history-list {
          max-height: none;
        }
      }
    </style>
  </head>
  <body>
    <div id="app"></div>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
      const { useEffect, useMemo, useState, useRef } = React;

      const SpotlightCard = ({
        children,
        className = "",
        spotlightColor = "rgba(42, 92, 255, 0.2)"
      }) => {
        const divRef = useRef(null);
        const [isFocused, setIsFocused] = useState(false);
        const [position, setPosition] = useState({ x: 0, y: 0 });
        const [opacity, setOpacity] = useState(0);

        const handleMouseMove = (event) => {
          if (!divRef.current || isFocused) return;

          const rect = divRef.current.getBoundingClientRect();
          setPosition({
            x: event.clientX - rect.left,
            y: event.clientY - rect.top
          });
        };

        const handleFocus = () => {
          setIsFocused(true);
          setOpacity(0.6);
        };

        const handleBlur = () => {
          setIsFocused(false);
          setOpacity(0);
        };

        const handleMouseEnter = () => {
          setOpacity(0.6);
        };

        const handleMouseLeave = () => {
          setOpacity(0);
        };

        return (
          <div
            ref={divRef}
            onMouseMove={handleMouseMove}
            onFocus={handleFocus}
            onBlur={handleBlur}
            onMouseEnter={handleMouseEnter}
            onMouseLeave={handleMouseLeave}
            className={`card ${className}`}
          >
            <div
              style={{
                position: "absolute",
                inset: 0,
                opacity,
                pointerEvents: "none",
                transition: "opacity 500ms ease-in-out",
                background: `radial-gradient(circle at ${position.x}px ${position.y}px, ${spotlightColor}, transparent 80%)`
              }}
            />
            <div style={{ position: "relative", zIndex: 1 }}>{children}</div>
          </div>
        );
      };

      const formatTimestamp = (value) => {
        if (!value) return "Unknown";
        const parsed = new Date(value);
        if (Number.isNaN(parsed.getTime())) return value;
        return new Intl.DateTimeFormat(undefined, {
          dateStyle: "medium",
          timeStyle: "short"
        }).format(parsed);
      };

      const App = () => {
        const [latest, setLatest] = useState(null);
        const [history, setHistory] = useState([]);
        const [error, setError] = useState(null);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
          const loadData = async () => {
            try {
              const [latestResponse, historyResponse] = await Promise.all([
                fetch("/latest"),
                fetch("/history")
              ]);

              if (latestResponse.ok) {
                const latestPayload = await latestResponse.json();
                setLatest(latestPayload);
              }

              if (historyResponse.ok) {
                const historyPayload = await historyResponse.json();
                setHistory(Array.isArray(historyPayload) ? historyPayload : []);
              }
            } catch (err) {
              setError("Unable to load readings right now.");
            } finally {
              setLoading(false);
            }
          };

          loadData();
        }, []);

        const sortedHistory = useMemo(() => {
          return [...history].sort((a, b) =>
            String(b.timestamp).localeCompare(String(a.timestamp))
          );
        }, [history]);

        return (
          <div>
            <header className="hero reveal">
              <span className="badge">BVK smart meter</span>
              <h1>Water usage, at a glance.</h1>
              <p>
                Live snapshot of the latest meter reading, with a timeline of
                recent measurements pulled directly from the BVK integration.
              </p>
            </header>

            <div className="grid">
              <SpotlightCard className="reveal" spotlightColor="rgba(42, 92, 255, 0.18)">
                <div className="section-title">
                  <span>Current reading</span>
                </div>
                {loading ? (
                  <p className="loading">Loading latest reading...</p>
                ) : latest ? (
                  <>
                    <div className="reading-value">{latest.reading} m³</div>
                    <div className="reading-meta">
                      Updated {formatTimestamp(latest.timestamp)}
                    </div>
                  </>
                ) : (
                  <div className="reading-meta">No reading available yet.</div>
                )}
                {error ? <p className="error">{error}</p> : null}
              </SpotlightCard>

              <div className="card reveal">
                <div className="section-title">
                  <span>History</span>
                  <span>{sortedHistory.length} entries</span>
                </div>
                {loading ? (
                  <p className="loading">Loading history...</p>
                ) : sortedHistory.length ? (
                  <div className="history-list">
                    {sortedHistory.map((item, index) => (
                      <div
                        key={`${item.timestamp}-${item.reading}-${index}`}
                        className="history-item"
                        style={{ animationDelay: `${index * 0.04}s` }}
                      >
                        <span>
                          <span className="history-reading">{item.reading} m³</span>
                          <span className="history-date">
                            {formatTimestamp(item.timestamp)}
                          </span>
                        </span>
                        <span className="history-date">#{index + 1}</span>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p className="reading-meta">No history saved yet.</p>
                )}
              </div>
            </div>

            <div className="footer">
              <span>API endpoints:</span>
              <a className="link-pill" href="/latest">/latest</a>
              <a className="link-pill" href="/history">/history</a>
            </div>
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById("app")).render(<App />);
    </script>
  </body>
</html>
